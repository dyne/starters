<!--
SPDX-FileCopyrightText: 2024 The Forkbomb Company

SPDX-License-Identifier: AGPL-3.0-or-later
-->

<script lang="ts">
	import CollectionManager from '$lib/collectionManager/collectionManager.svelte';
	import { pb } from '$lib/pocketbase/index.js';
	import {
		Collections,
		OrgJoinRequestsStatusOptions,
		type OrgJoinRequestsRecord,
		type UsersResponse,
		type OrgAuthorizationsRecord,
		type OrgJoinRequestsResponse,
		type OrganizationsResponse
	} from '$lib/pocketbase/types';
	import { OrgRoles } from '$lib/organizations';
	import { createTypeProp } from '$lib/utils/typeProp.js';
	import { m } from '$lib/i18n';
	import { Button, Modal } from 'flowbite-svelte';
	import { UserPlus, NoSymbol, UserGroup } from 'svelte-heros-v2';
	import DeleteRecord from '$lib/collectionManager/ui/recordActions/deleteRecord.svelte';
	import PlainCard from '$lib/components/plainCard.svelte';
	import { getUserDisplayName } from '$lib/utils/pb';
	import UserAvatar from '$lib/components/userAvatar.svelte';
	import Icon from '$lib/components/icon.svelte';
	import EmptyState from '$lib/components/emptyState.svelte';
	import SectionTitle from '$lib/components/sectionTitle.svelte';
	import { createToggleStore } from '$lib/components/utils/toggleStore';
	import PortalWrapper from '$lib/components/portalWrapper.svelte';

	//

	export let organization: OrganizationsResponse;

	const recordType = createTypeProp<OrgJoinRequestsResponse<{ user: UsersResponse }>>();

	//

	const { accepted, rejected, pending } = OrgJoinRequestsStatusOptions;

	async function updateRequestStatus(
		request: OrgJoinRequestsResponse,
		status: OrgJoinRequestsStatusOptions
	) {
		await pb.collection('orgJoinRequests').update(request.id, {
			status
		} satisfies Partial<OrgJoinRequestsRecord>);
	}

	//

	const isDeclineModalOpen = createToggleStore(false);
</script>

<CollectionManager
	collection={Collections.OrgJoinRequests}
	initialQueryParams={{
		filter: `organization.id = "${organization.id}" && status = "${pending}"`,
		expand: 'user'
	}}
	{recordType}
	let:records
>
	<SectionTitle
		tag="h5"
		title={m.Pending_membership_requests()}
		description={m.pending_membership_requests_description()}
	/>

	<svelte:fragment slot="emptyState">
		<EmptyState icon={UserGroup} title={m.No_new_membership_requests()}></EmptyState>
	</svelte:fragment>

	{#each records as request}
		{@const user = request.expand?.user}
		{#if user}
			<PlainCard>
				<UserAvatar slot="left" size="md" {user}></UserAvatar>
				{getUserDisplayName(user)}

				<svelte:fragment slot="right">
					<div class="space-x-1">
						<Button
							outline
							on:click={() => {
								updateRequestStatus(request, accepted);
							}}
						>
							{m.Accept()}
							<Icon src={UserPlus} ml></Icon>
						</Button>

						<Button outline on:click={isDeclineModalOpen.on}>
							{m.Decline()}
							<Icon src={NoSymbol} ml></Icon>
						</Button>
					</div>
				</svelte:fragment>
			</PlainCard>

			<PortalWrapper>
				<Modal bind:open={$isDeclineModalOpen} title={m.Warning()} size="xs">
					<p>{m.decline_membership_request_warning()}</p>
					<div class="flex items-center justify-center gap-2">
						<Button color="alternative" on:click={isDeclineModalOpen.off}>
							{m.Cancel()}
						</Button>
						<Button
							color="red"
							on:click={() => updateRequestStatus(request, rejected).then(isDeclineModalOpen.off)}
						>
							{m.decline_membership_request()}
						</Button>
					</div>
				</Modal>
			</PortalWrapper>
		{/if}
	{/each}
</CollectionManager>
