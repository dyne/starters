<!--
SPDX-FileCopyrightText: 2024 The Forkbomb Company

SPDX-License-Identifier: AGPL-3.0-or-later
-->

<script lang="ts">
	import { invalidateAll } from '$app/navigation';
	import { currentUser, pb } from '@/pocketbase/index.js';
	import {
		OrgJoinRequestsStatusOptions,
		type OrgJoinRequestsRecord,
		type OrganizationsResponse
	} from '@/pocketbase/types';
	import { m } from '$lib/i18n';
	import { Avatar, Button, Modal, P } from 'flowbite-svelte';
	import PageTop from '$lib/components/pageTop.svelte';
	import Icon from '$lib/components/icon.svelte';
	import { ArrowLeft, UserGroup, UserPlus } from 'svelte-heros-v2';
	import SectionTitle from '$lib/components/sectionTitle.svelte';
	import PageContent from '$lib/components/pageContent.svelte';
	import PageCard from '$lib/components/pageCard.svelte';
	import EmptyState from '$lib/components/emptyState.svelte';
	import PlainCard from '$lib/components/plainCard.svelte';
	import ModalWrapper from '$lib/components/modalWrapper.svelte';

	//

	export let data;
	$: organizations = data.organizations;
	$: orgJoinRequests = data.orgJoinRequests;

	//

	async function sendJoinRequest(org: OrganizationsResponse) {
		await pb.collection('orgJoinRequests').create({
			user: $currentUser?.id!,
			organization: org.id!,
			status: OrgJoinRequestsStatusOptions.pending,
			reminders: 0
		} satisfies OrgJoinRequestsRecord);
		invalidateAll();
	}

	function isRequestAlreadySent(org: OrganizationsResponse): boolean {
		return Boolean(orgJoinRequests.find((request) => request.organization == org.id));
	}
</script>

<PageTop>
	<Button href="/my/organizations" outline size="xs">
		<Icon src={ArrowLeft} mr></Icon>
		{m.Back_to_my_organizations()}
	</Button>

	<SectionTitle title={m.Join_an_organization()} hideLine></SectionTitle>
</PageTop>

<PageContent>
	<PageCard>
		{#if data.organizations.length == 0}
			<EmptyState title={m.No_available_organizations_found()} icon={UserGroup} />
		{:else}
			<div class="space-y-4">
				{#each organizations as org}
					{@const avatarUrl = pb.files.getUrl(org, org.avatar)}
					{@const hasDescription = Boolean(org.description)}

					<PlainCard let:Title let:Description>
						<div class="flex items-center gap-4">
							<Avatar src={avatarUrl} size="md" class="shrink-0" />
							<div>
								<Title>{org.name}</Title>
								{#if hasDescription}
									<Description>
										<span class="line-clamp-2">
											{@html org.description}
										</span>
									</Description>
								{/if}
							</div>
						</div>

						<div slot="right" class="shrink-0 self-start pl-8">
							{#if !isRequestAlreadySent(org)}
								<ModalWrapper title={`${m.Send_a_request_to()} ${org.name}`} let:openModal>
									<Button outline on:click={openModal}>
										{m.Join()}
										<Icon src={UserPlus} ml></Icon>
									</Button>

									<svelte:fragment slot="modal" let:closeModal>
										<P>{m.Please_confirm_that_you_want_to_join_this_organization_()}</P>
										<div class="flex items-center justify-center gap-2">
											<Button color="alternative" on:click={closeModal}>
												{m.Cancel()}
											</Button>
											<Button on:click={() => sendJoinRequest(org).then(closeModal)}>
												{m.Send_join_request()}
											</Button>
										</div>
									</svelte:fragment>
								</ModalWrapper>
							{:else}
								<Button color="alternative" disabled>{m.Request_sent()}</Button>
							{/if}
						</div>
					</PlainCard>
				{/each}
			</div>
		{/if}
	</PageCard>
</PageContent>
